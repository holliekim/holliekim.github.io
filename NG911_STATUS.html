<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>NG911 Status</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.5/esri/css/main.css">

<script src="https://js.arcgis.com/4.5/"></script>

<style>
	#viewDiv { width: 950px; height: 800px;}

	.esri-component.esri-layer-list.esri-widget.esri-widget--panel{
		width: 254px;
		padding-bottom: 1px;
	}

	.esri-layer-list__item--has-children > .esri-layer-list__item-container {
  	font-weight: bold;
  	font-size: 9pt;
  	color: black;
  	background-color: rgb(211, 211, 211);
	}

	.esri-layer-list__item-container {
  	height: 16px;
  	padding-top: 1px;
	}

	.esri-layer-list__child-toggle [class*="esri-icon"] {
		color: black;
	}

	.esri-layer-list__item-toggle-icon {
		color: black;
		font-size: 12px;
	}



	.esri-legend__service p {
		line-height: 0em;
	}

	.esri-legend {
		font-size: 0pt;
	}

	.esri-legend__service-label {
		font-size: 10pt;
	}

	.esri-legend__service.esri-legend__group-layer {
  	padding-top: 9px;
  	padding-left: 5px;
  	padding-right: 1px;
  	padding-bottom: 1px;
	}

	.esri-component.esri-legend.esri-widget {
  	padding-top: 0px;
  	padding-left: 0px;
  	padding-right: 1px;
  	padding-bottom: 1px;
	}

	.esri-legend__service.esri-legend__group-layer-child {
  	padding-left: 5px;
  	padding-right: 1px;
  	padding-bottom: 1px;
	}

	.esri-legend__layer-caption {
  	padding-top: 0px;
  	padding-bottom: 0px;
	}


</style>
</head>

<body>
<script type="text/javascript">

//variable
var done;

function expandlayerlist (){
	if (!done){
	done = true;
	var ctSpans = document.getElementsByClassName("esri-layer-list__child-toggle");

	for (var i = 0; i < ctSpans.length; i++){
		ctSpans[i]["data-item"].open = true;
	}
	}
}
</script>

<div id= "viewDiv" ></div>

<script>
require([
	"esri/Map",
	"esri/views/MapView",
	"esri/layers/FeatureLayer",
	"esri/widgets/Home",
	"esri/widgets/LayerList",
	"esri/widgets/Legend",
	"esri/layers/GroupLayer",
	"esri/symbols/TextSymbol",
	"esri/layers/GraphicsLayer",
	"esri/Graphic",
	"esri/geometry/Point",
	"esri/layers/MapImageLayer",
	"esri/layers/TileLayer",
	"esri/PopupTemplate",
	"esri/config",
	"dojo/domReady!"
], function (Map, MapView, FeatureLayer, Home, LayerList, Legend, GroupLayer, TextSymbol, GraphicsLayer, Graphic, Point, MapImageLayer, TileLayer, PopupTemplate, esriConfig){

	esriConfig.request.corsEnabledServers.push("holliekim.com");
	
	var map = new Map({});

	//basemap with few labels
	var basemap = new TileLayer({
		url: "https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer",
		listMode: "hide"
	});

	//mapview
	var view = new MapView({
		container: "viewDiv",
		map: map,
		extent: {
            xmin: -87.418494,
            ymin: 43.274570,
            xmax: -97.517553,
            ymax: 49.421187,
            spatialReference: 4326
          },
		//center: [-92.4, 46.35],
		//zoom: 6.5
		constraints: {
    		rotationEnabled: false
  		}
	});

	//disable pop up dock
	view.popup.dockOptions = {buttonEnabled: false};

	//Add dynamic county labels using ESRI's USA map
/*	var countylabellayer = new MapImageLayer({
		url: "https://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer",
		listMode: "hide",
        sublayers: [{
          id: 3,
          definitionExpression: "state_name = 'Minnesota'",
          popupTemplate:{
          	title: "{name}"
          },
          //make features invisible, keeps labels on
          opacity: 0,
          labelsVisible: true,
          labelingInfo: [{
            labelExpression: "[name]",
            labelPlacement: "always-horizontal",
            symbol: new TextSymbol({
           	  //vvv
              //haloColor: "white",
              //haloSize: "1.5px",
              //^^^
              color: "black",
              font: {
              	//vvv
              	family :"calibri",
              	//^^^

              	//vvv
                size: 8,
                //weight: "bold"
                //^^^
              }
            })
          }]
      	}]
  	});

	//add label for RLN
	var text = new TextSymbol({
		//vvv
		//haloColor: "white",
		//haloSize: "1.5px",
		//^^^

		text: "Red Lake Nation",
		color: "black",
		font: {
			size: 8,
			//vvv
			family: "calibri",
			//weight: "bold"
			//^^^
		}
	});

	//graphic layer to hold RLN label
	var glayer = new GraphicsLayer({
		listMode: "hide"
	});

	//create label
	var g = new Graphic();

	//00962

	g.geometry = new Point(-95.146233, 48.116481);
    g.symbol = text;
    glayer.add(g);*/

	var allboundaries = new MapImageLayer({
			url: "https://ng911.gisdata.mn.gov/arcgis/rest/services/Status_Map/NG911_Status_Map_Boundaries/MapServer",
			listMode:"hide",
			sublayers:[
			{
				//PSAP boundaries
				id: 1,
				opacity: 0,
				// renderer: {
				// 	type: "simple",
				// 	symbol: {
				// 		type: "simple-fill",
				// 		outline: {
				// 			width: 10,
				// 			color: "gray"
				// 		}
				// 	}
				// },
				labelsVisible: true,
				labelingInfo: [{
					labelExpression: "[psap]",
					labelPlacement: "always-horizontal",
					symbol: {
						type: "text",
						color: "black",
						haloColor: "white",
						haloSize: "1.5px",
						font: {
							size: 8,
							weight: "bold"
						}
					}
				}]
			},
			{
				// ECN Regions
				id: 0,
				opacity: .9,
				labelsVisible: true,
				labelingInfo: [{
					labelExpression: "UCase([sheet1__re])",
					labelPlacement: "always-horizontal",
					symbol: {
						type: "text",
						haloColor: "#2b2f33",
						haloSize: "2px",
						color: "white",
						font: {
							size: 10,
							weight: "bold"
						}
					},
				}]
		}
		]
	});


  //home button
	var homebutton = new Home({
		view: view
	});

	//layer list
	var layerlist = new LayerList({
		view: view
	});


  var defaultSym = {
      type: "simple-fill", // autocasts as new SimpleFillSymbol()
      outline: { // autocasts as new SimpleLineSymbol()
        color: "black",
        width: 0.5
      }
  };

	//color ramp for change layers
	var renderer1 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ADP_RCL_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}]
		}]
	};

	var renderer2 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ALI_RCL_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}	]
		}]
	};

	var renderer3 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ALI_ADP_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}	]
		}]
	};


	// Add each layer to Group Layer by category
	var geocoding = new GroupLayer ({
		title: "Geocoding",
		visibilityMode: "exclusive",

		layers:[
		new FeatureLayer({
			title: "ADP to RCL Change",
			renderer: renderer1,
			portalItem: {id: "c39d1ef576a0417ea82e1c121713156f"},
			popupEnabled: false,
		}),
		new FeatureLayer({
			title: "ALI to RCL Change",
			renderer: renderer2,
			portalItem: {id: "0de5c209c56d4ac1aa582f39f1312acc"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "ALI to ADP Change",
			renderer: renderer3,
			portalItem: {id: "89ca86b7c95e463fbe34ea7cd6279303"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "ADP to RCL",
			portalItem: {id: "699486c81b5c4ad8aa411d3dbe4e0433"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "ALI to RCL",
			portalItem:{id: "ef7f797139514ba08e1332d8b32bbfaa"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "ALI to ADP",
			portalItem: {id: "7b46fa64799f42a9a2191e8a86e57a61"},
			popupEnabled: false

		}),
		],
		visible: false
	});

	var validation = new GroupLayer ({
		title: "Validation Phase",
		visibilityMode: "exclusive",
		layers:[
		new FeatureLayer({
			title: "ESZs",
			portalItem: {id:"ed067477dcad46e98dc09652d1f90bf9"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "Geospatial",
			portalItem: {id: "6705af24a6084751b32b6c504b44f6e4"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "Address Progress",
			portalItem: {id:"5b83cfb6f0ab420886380a3e75dc3bd9"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "Address",
			portalItem: {id: "6101f17dac9e47d58b5ec8f2c51a12d4"},
			popupEnabled: false
		}),

		new FeatureLayer({
			title: "Street Name Progress",
			portalItem: {id:"fab2ea8447ec467780ab47560d58d9d3"},
			popupEnabled: false
		}),
		new FeatureLayer({
			title: "Street Name",
			portalItem: {id: "23f5382a0b874157836ee53ae55c7d10"},
			popupEnabled: false

		}),
		new FeatureLayer({
			title: "Community Name Progress",
			portalItem: {id:"e58edff1ec044794b4731d4b485db252"},
			popupEnabled: false

		}),
		new FeatureLayer({
			title: "Community Name",
			portalItem:{id: "0548fe8a577547c6bd7a78beb650f844"},
			popupEnabled: false

		}),
		new FeatureLayer({
			title: "Current Phase",
			portalItem: {id:"bff9c4f913c344ca8e0d2d8b9abe810d"},
			popupEnabled: false
		})
		],

	});

	var datacollect = new GroupLayer({
		title: "Data Collection",
		visibilityMode: "exclusive",
		layers:[
			new FeatureLayer({
				portalItem: {id: "3446019e902d49009d2c176f1ded72f2"},
				popupEnabled: false
			}),
			new FeatureLayer({
				title: "ESZs",
				portalItem: {id: "f7c9b61c166040cda6b9a7e870657671"},
				popupEnabled: false
			}),
			new FeatureLayer({
				portalItem: {id: "bb3c849cecfd4f1cb899ac48adb93731"},
				popupEnabled: false
			}),
			new FeatureLayer({
				title: "Road Centerlines",
				portalItem:{id:"2faeb06a0eea4552b65db7e306b638ba"},
				popupEnabled: false
			}),
			new FeatureLayer({
				title: "Address Point Gaps",
				portalItem: {id:"94c5a80f4fd5406694fceb14cb844538"},
				popupEnabled: false
			}),
			new FeatureLayer({
				portalItem: {id: "cb1e71cebeb14f1da6003545fbd9cbdb"},
				popupEnabled: false
			}),
			new FeatureLayer ({
				title: "Address Points",
				portalItem:{id:"4ffe231f54c0400d8776180c3eeecfb1"},
				popupEnabled: false
			})
		],
		visible: false
	});

	//add all group layers to main group layer
	var alllayers = new GroupLayer({
		title: "Layers",
		visibilityMode: "exclusive"
	});


	alllayers.add(datacollect);
	alllayers.add(geocoding);
	alllayers.add(validation);


	//legend
	var legend = new Legend ({
		view: view,
		layerInfos: [{
          layer: geocoding
     	},{
          layer: validation
      },{
      	  layer: datacollect
      }]
     });


	//add basemap and layers
	map.add(basemap);
	map.add(alllayers);
	map.add(allboundaries);

	//add buttons, layers, legend
	view.ui.add(homebutton, "top-left");
	view.ui.add(layerlist, "top-right");
	view.ui.add(legend, "bottom-right");

	//wait for last layer to load...then run expandlayer list to open up layerlist
	view.whenLayerView(alllayers).then(function(lyrView){
	  lyrView.watch("updating", function(val){
	    if(!val){  // wait for the layer view to finish updating
	      expandlayerlist();
	    }
	  });
	});


//
});
</script>

</body>
</html>
