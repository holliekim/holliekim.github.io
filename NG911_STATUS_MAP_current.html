<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>NG911 Status</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.8/esri/css/main.css">

<script src="https://js.arcgis.com/4.8/"></script>

<style>
	#viewDiv { width: 950px; height: 800px;}


  .esri-component.esri-layer-list.esri-widget.esri-widget--panel{
    	width: 254px;
    	padding-bottom: 1px;
    }

	.esri-layer-list__item--has-children > .esri-layer-list__item-container {
    	font-weight: bold;
    	font-size: 9pt;
    	color: black;
    	background-color: rgb(211, 211, 211);
	}

	.esri-layer-list__item-container {
    	height: 15px;
    	padding-top: 1px;
    	background-color: rgb(247, 247, 247);
    }

	.esri-layer-list__child-toggle [class*="esri-icon"] {
		color: black;
	}

	.esri-layer-list__item-toggle-icon {
		color: black;
		font-size: 12px;
	}

	.esri-layer-list__item-title {
		color: black;

	}



	.esri-legend__service p {
		line-height: 0em;
	}

	 .esri-legend__service {
		padding-bottom: 0px;
		padding-top: 0px;
	}

  .esri-ui-corner .esri-expand .esri-widget--panel, .esri-ui-corner .esri-expand .esri-widget--panel-height-only, .esri-ui-corner .esri-component.esri-widget--panel {
    	width: 254px;
	}

	.esri-legend__layer-cell--info {
		padding-top: 0px;
		padding-bottom: 0px;
	}

	h3.esri-widget__header, h4.esri-widget__header, h5.esri-widget__header, h6.esri-widget__header{
		font-size: 10pt;
		margin-bottom: 0px;
	}

	/*for version 4.9*/
	/* h3.esri-widget__heading, h4.esri-widget__heading, h5.esri-widget__heading, h6.esri-widget__heading {
		font-size: 10pt;
		margin-bottom: 0px;
	} */

	.esri-legend__service.esri-legend__group-layer {
			padding-top: 0px;
			padding-left: 5px;
			padding-right: 1px;
			padding-bottom: 0px;
		}

	.esri-legend__service.esri-legend__group-layer-child {
		padding-top: 0px;
		padding-left: 5px;
		padding-right: 1px;
		padding-bottom: 0px;
	}

	.esri-legend__layer-caption {
		display: none;
	}

	.esri-legend__layer-table--size-ramp{
		margin-bottom: 0px;
	}

</style>

</head>

<body>
<script type="text/javascript">

//variable
var done;

function expandlayerlist (){
	if (!done){
	done = true;
	var ctSpans = document.getElementsByClassName("esri-layer-list__child-toggle");

	for (var i = 0; i < ctSpans.length; i++){
		ctSpans[i]["data-item"].open = true;
	}
	}
}
</script>

<div id= "viewDiv" ></div>

<script>
require([
	"esri/Map",
	"esri/views/MapView",
	"esri/layers/FeatureLayer",
	"esri/widgets/Home",
	"esri/widgets/LayerList",
	"esri/widgets/Legend",
	"esri/layers/GroupLayer",
	"esri/symbols/TextSymbol",
	"esri/layers/GraphicsLayer",
	"esri/Graphic",
	"esri/geometry/Point",
	"esri/layers/MapImageLayer",
	"esri/layers/TileLayer",
	"esri/PopupTemplate",
	"dojo/domReady!"
], function (Map, MapView, FeatureLayer, Home, LayerList, Legend, GroupLayer, TextSymbol, GraphicsLayer, Graphic, Point, MapImageLayer, TileLayer, PopupTemplate){

	var map = new Map({});

	//basemap with few labels
	var basemap = new TileLayer({
		url: "https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer",
		listMode: "hide"
	});

	//mapview
	var view = new MapView({
		container: "viewDiv",
		map: map,
		extent: {
            xmin: -87.418494,
            ymin: 43.274570,
            xmax: -97.517553,
            ymax: 49.421187,
            spatialReference: 4326
          },
		//center: [-92.4, 46.35],
		//zoom: 6.5
		constraints: {
    		rotationEnabled: false
  		}
	});

	//pop up dock
	view.popup.dockOptions = {position: "bottom-left"};

    //home button
	var homebutton = new Home({
		view: view
	});

	//layer list
	var layerlist = new LayerList({
		view: view
	});


  var defaultSym = {
      type: "simple-fill", // autocasts as new SimpleFillSymbol()
      outline: { // autocasts as new SimpleLineSymbol()
        color: "black",
        width: 0.5
      }
  };

	//color ramp for change layers
	var renderer1 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ADP_RCL_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}]
		}]
	};

	var renderer2 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ALI_RCL_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}	]
		}]
	};

	var renderer3 = {
		type: "simple",
		symbol: defaultSym,
		label: "% change in geocoding match rates",
		visualVariables: [{
			type: "color",
			field:"ALI_ADP_re",
			stops: [
			{
				value: -1,
				color: "#543005",
				label: "-100%"
			},
			{
				value: -.25,
				color: "#bf812d",
				label: "-25%"
			},
			{
				value: 0,
				color: "#ffffff",
				label: "0"
			},
			{
				value: .25,
				color: "#01665e",
				label: "+25%"
			},
			{
				value: 1,
				color: "#003c30",
				label: "+100%"
			}	]
		}]
	};

	//popup templates
	currentvalidation = function(s) {
		if (s == 'CNV')
			return 'Community Name Validation'
		else if (s == 'SNV')
			return 'Street Name Validation'
		else if (s == 'AV')
			return 'Address Validation'
		else if (s == 'GV')
			return 'Geospatial Validation'
		else if (s == 'ESZV')
			return 'Emergency Service Zone Validation'
		else
			return 'Not Started'
	};

	phasecomplete = function(t) {
		if (t == 'In Progress')
			return 'is <b>in progress</b>'
		else if (t == 'Not Started')
			return 'has <b>not started</b>'
		else
			return 'is <b>complete</b>'
	};

	cnvphaseprogress = function(i) {
		var percent = (i * 100).toFixed(0);
		if (i== -1)
			return "unavailable"
		else
			return percent.toString() + "%"
	};

	snvphaseprogress = function(q) {
		var percent = (q * 100).toFixed(0);
		if (q == -.01)
			return "unavailable"
		else
			return percent.toString() + "%"
	};

	avphaseprogress = function(z) {
		var percent = (z * 100).toFixed(0);
		if (z == 0)
			return "unavailable"
		else
			return percent.toString() + "%"
	};

	geocodepercent = function (n) {
		if (n != -5){
			var percent = (n * 100).toFixed(0);
			return percent.toString() + "%";
		}
		else
			return 'unavailable.'
	};

	changepercent = function (m) {
		var percent = (m * 100).toFixed(2);

		if (percent == 0)
			return ''
		else
			return percent.toString() + "%";
	};

	iord = function (v) {
		if (v < 0)
			return 'decreased by'
		else if (v > 0)
			return 'increased by'
		else if (v == 0)
			return 'did not change.'
	};

	datastatus = function(a) {
		if (a == '1/0/1900')
			return 'Data has not been received'
		else if (a == '0/0/0000')
			return 'Data not available'
		else
			return 'Data has been received'
	};

	agecategory = function (cat) {
		if (cat == '0')
			return "unknown"
		else if (cat =='1')
			return 'less than one month ago'
		else if (cat == '2')
			return 'between 1 and 3 months ago'
		else if (cat == '3')
			return 'between 3 and 6 months ago'
		else if (cat == '4')
			return 'between 6 months and 1 year ago'
		else if (cat == '5')
			return 'more than 1 year ago'
	};

	addresspointgap = function (g) {
		if (g == 'Full coverage')
			return 'have full coverage'
		else if (g == 'Not Available')
			return 'are not available'
		else
			return 'have partial coverage'
	};

	// Add each layer to Group Layer by category
	var geocoding = new GroupLayer ({
		title: "Geocoding",
		visibilityMode: "exclusive",

		layers:[
		new FeatureLayer({
			title: "ADP to RCL Change",
			renderer: renderer1,
			portalItem: {id: "c39d1ef576a0417ea82e1c121713156f"},
			popupTemplate:{
				title: "Address Points to Centerlines Geocoding Change",
				content: [{
					type: "text",
					text: "The match rate for <b>{PSAP}</b> {ADP_RCL_re:iord} {ADP_RCL_re:changepercent}"
				}]
			}
		}),
		new FeatureLayer({
			title: "ALI to RCL Change",
			renderer: renderer2,
			portalItem: {id: "0de5c209c56d4ac1aa582f39f1312acc"},
			popupTemplate:{
				title: "ALI to Centerlines Geocoding Change",
				content: [{
					type: "text",
					text: "The match rate for <b>{PSAP}</b> {ALI_RCL_re:iord} {ALI_RCL_re:changepercent}"
				}]
			}
		}),
		new FeatureLayer({
			title: "ALI to ADP Change",
			renderer: renderer3,
			portalItem: {id: "89ca86b7c95e463fbe34ea7cd6279303"},
			popupTemplate:{
				title: "ALI to Address Points Geocoding Change",
				content: [{
					type: "text",
					text: "The match rate for <b>{PSAP}</b> {ALI_ADP_re:iord} {ALI_ADP_re:changepercent}"
				}]
			}
		}),
		new FeatureLayer({
			title: "ADP to RCL",
			portalItem: {id: "699486c81b5c4ad8aa411d3dbe4e0433"},
			popupTemplate:{
				title: "Address Points to Centerlines Geocoding Match Rate",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: {CURRENT_RA:geocodepercent} match rate"
				}]
			}
		}),
		// new FeatureLayer({
		// 	title: "ALI to RCL",
		// 	portalItem:{id: "8d999f9836fd4d8ea882ea401544afa9"},
		// 	popupTemplate:{
		// 		title: "GDB",
		// 		content: [{
		// 			type: "text",
		// 			text: "<b>{PSAP}</b>: {CURRENT_RA:geocodepercent} match rate"
		// 		}]
		// 	}
		// }),
		new FeatureLayer({
			title: "ALI to RCL",
			portalItem:{id: "ef7f797139514ba08e1332d8b32bbfaa"},
			popupTemplate:{
				title: "ALI to Centerlines Geocoding Match Rate",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: {CURRENT_RA:geocodepercent} match rate"
				}]
			}
		}),
		new FeatureLayer({
			title: "ALI to ADP",
			portalItem: {id: "7b46fa64799f42a9a2191e8a86e57a61"},
			popupTemplate:{
				title: "ALI to Address Points Geocoding Match Rate",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: {CURRENT_RA:geocodepercent} match rate"
				}]
			}
		}),
		],
		visible: false
	});

	var validation = new GroupLayer ({
		title: "Validation Phase",
		visibilityMode: "exclusive",
		layers:[

		new FeatureLayer({
			title: "ESZs",
			portalItem: {id:"ed067477dcad46e98dc09652d1f90bf9"},
			popupTemplate:{
				title: "Emergency Service Zone Validation",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: Emergency Service Zone Validation {GV:phasecomplete}"
				}]
			}
		}),

		new FeatureLayer({
			title: "Geospatial",
			portalItem: {id: "6705af24a6084751b32b6c504b44f6e4"},
			popupTemplate:{
				title: "Geospatial Validation",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: Geospatial Validation {GV:phasecomplete}"
				}]
			}
		}),
		new FeatureLayer({
			title: "Address Progress",
			portalItem: {id:"5b83cfb6f0ab420886380a3e75dc3bd9"},
			popupTemplate:{
				title: "Address Validation Progress",
				content:[{
					type: "text",
					text: "Average geocoding match rate for <b>{PSAP}</b> is {AV_AVERAGE:avphaseprogress}"
				}]
			}
		}),

		new FeatureLayer({
			title: "Address",
			portalItem: {id: "6101f17dac9e47d58b5ec8f2c51a12d4"},
			popupTemplate:{
				title: "Address Validation",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: Address Validation {AV:phasecomplete}"
				}]
			}
		}),

		new FeatureLayer({
			title: "Street Name Progress",
			portalItem: {id:"fab2ea8447ec467780ab47560d58d9d3"},
			popupTemplate:{
				title: "Street Name Validation Progress",
				content:[{
					type: "text",
					text: "Estimated percent complete for <b>{PSAP}</b> is {SNV_p:snvphaseprogress}"
				}]
			}

		}),

		new FeatureLayer({
			title: "Street Name",
			portalItem: {id: "23f5382a0b874157836ee53ae55c7d10"},
			popupTemplate:{
				title: "Street Name Validation",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: Street Name Validation {SNV:phasecomplete}"
				}]
			}

		}),
		new FeatureLayer({
			title: "Community Name Progress",
			portalItem: {id:"e58edff1ec044794b4731d4b485db252"},
			popupTemplate:{
				title: "Community Name Validation Progress",
				content:[{
					type: "text",
					text: "Estimated percent complete for <b>{PSAP}</b> is {CNV_p:cnvphaseprogress}"
				}]
			}

		}),
		new FeatureLayer({
			title: "Community Name",
			portalItem:{id: "0548fe8a577547c6bd7a78beb650f844"},
			popupTemplate:{
				title: "Community Name Validation",
				content: [{
					type: "text",
					text: "<b>{PSAP}</b>: Community Name Validation {CNV:phasecomplete}"
				}]
			}

		}),
		new FeatureLayer({
			title: "Current Phase",
			portalItem: {id:"bff9c4f913c344ca8e0d2d8b9abe810d"},
			popupTemplate: {
				title: "Current Validation Phase",
				content: [{
					type: "text",
					text:"<b>{PSAP}</b>: {C:currentvalidation}"
				}]
			}
		})
		],
	});

	var datacollect = new GroupLayer({
		title: "Data Collection",
		visibilityMode: "exclusive",
		layers:[
			new FeatureLayer({
				portalItem: {id: "3446019e902d49009d2c176f1ded72f2"},
				popupTemplate:{
					title: "ESZ Data Last Received",
					content: [{
						type: "text",
						text: "Received ESZ data from <b>{PSAP}</b> {category:agecategory}"
					}]
				}
			}),
			new FeatureLayer({
				title: "ESZs",
				portalItem: {id: "f7c9b61c166040cda6b9a7e870657671"},
				popupTemplate:{
					title: "Emergency Service Zone Data",
					content: [{
						type: "text",
						text: "{ESZ:datastatus} for <b>{PSAP}</b>"
					}]
				}
			}),
			new FeatureLayer({
				portalItem: {id: "bb3c849cecfd4f1cb899ac48adb93731"},
				popupTemplate:{
					title: "Road Centerline Data Last Received",
					content: [{
						type: "text",
						text: "Received road centerline data data from <b>{PSAP}</b> {category:agecategory}"
					}]
				}
			}),
			new FeatureLayer({
				title: "Road Centerlines",
				portalItem:{id:"2faeb06a0eea4552b65db7e306b638ba"},
				popupTemplate:{
					title: "Road Centerline Data",
					content: [{
						type: "text",
						text: "{RCL:datastatus} for <b>{PSAP}</b>"
					}]
				}
			}),
			new FeatureLayer({
				title: "Address Point Gaps",
				portalItem: {id:"94c5a80f4fd5406694fceb14cb844538"},
				popupTemplate:{
					title: "Address Point Gaps (missing areas)",
					content: [{
						type: "text",
						text: "<b>{PSAP}</b> address points {ADP:addresspointgap}"
					}]
				}
			}),
			new FeatureLayer({
				portalItem: {id: "cb1e71cebeb14f1da6003545fbd9cbdb"},
				popupTemplate:{
					title: "Address Point Data Last Received",
					content: [{
						type: "text",
						text: "Received address point data data from <b>{PSAP}</b> {category:agecategory}"
					}]
				}
			}),
			new FeatureLayer ({
				title: "Address Points",
				portalItem:{id:"4ffe231f54c0400d8776180c3eeecfb1"},
				popupTemplate:{
					title: "Address Point Data",
					content: [{
						type: "text",
						text: "{AP:datastatus} for <b>{PSAP}</b>"
					}]
				}
			})
		],
		visible: false
	});


	//ECN regions and generalized PSAP boundaries
	var allboundaries = new MapImageLayer({
			url: "https://ng911.gisdata.mn.gov/arcgis/rest/services/Status_Map/NG911_Status_Map_Boundaries/MapServer",
			listMode:"hide",
			sublayers: [
			{
				id: 1,
				opacity: 0,
				labelsVisible: true,
				labelingInfo: [{
					labelExpression: "[psap]",
					labelPlacement: "always-horizontal",
							symbol: new TextSymbol({
								haloColor: "white",
								haloSize: "1.5px",
								color: "black",
								font: {
									family: "sans-serif",
									size: 8,
									weight: "bold"
								}
							})
						}]
			},
			{
				id: 0,
				opacity: .9,
				renderer: {
					type: "simple",
					symbol: {
						type: "simple-fill",
						style: "none",
						outline: {
							width: 4,
							color: "black"
							//color: "#222326",
						}
					}
				},
				labelsVisible: true,
				labelingInfo: [{
					labelExpression: "UCase([sheet1__re])",
					labelPlacement: "always-horizontal",
					symbol: new TextSymbol({
						haloColor: "#32363a",
						haloSize: "2.5px",
						color: "white",
						opacity: .6,
						font: {
							family: "sans-serif",
							size: 10,
							weight: "bold"
						}
					})
				}]
			}
		]
	});

	//add all group layers to main group layer
	var alllayers = new GroupLayer({
		title: "Layers",
		visibilityMode: "exclusive"
	});


	alllayers.add(datacollect);
	alllayers.add(geocoding);
	alllayers.add(validation);


	//legend
	var legend = new Legend ({
		view: view,
		layerInfos: [{
          layer: geocoding
     	},{
          layer: validation
      },{
      	  layer: datacollect
      }]
     });


	//add basemap and layers

	map.add(basemap);
	map.add(alllayers);
	map.add(allboundaries);



	//add buttons, layers, legend
	view.ui.add(homebutton, "top-left");
	view.ui.add(layerlist, "top-right");
	view.ui.add(legend, "bottom-right");

	//wait for last layer to load...then run expandlayer list to open up layerlist
	view.whenLayerView(alllayers).then(function(lyrView){
	  lyrView.watch("updating", function(val){
	    if(!val){  // wait for the layer view to finish updating
	      expandlayerlist();
	    }
	  });
	});


//
});
</script>

</body>
</html>
